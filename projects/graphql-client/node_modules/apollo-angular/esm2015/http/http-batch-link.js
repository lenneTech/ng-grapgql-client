import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ApolloLink, Observable as LinkObservable, } from '@apollo/client/core';
import { BatchLink } from '@apollo/client/link/batch';
import { print } from 'graphql';
import { createHeadersWithClientAwereness, fetch, mergeHeaders, prioritize, } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
const defaults = {
    batchInterval: 10,
    batchMax: 10,
    uri: 'graphql',
    method: 'POST',
};
export class HttpBatchLinkHandler extends ApolloLink {
    constructor(httpClient, options) {
        super();
        this.httpClient = httpClient;
        this.options = options;
        this.batchInterval = options.batchInterval || defaults.batchInterval;
        this.batchMax = options.batchMax || defaults.batchMax;
        const batchHandler = (operations) => {
            return new LinkObservable((observer) => {
                const body = this.createBody(operations);
                const headers = this.createHeaders(operations);
                const { method, uri, withCredentials } = this.createOptions(operations);
                if (typeof uri === 'function') {
                    throw new Error(`Option 'uri' is a function, should be a string`);
                }
                const req = {
                    method,
                    url: uri,
                    body: body,
                    options: {
                        withCredentials,
                        headers,
                    },
                };
                const sub = fetch(req, this.httpClient, () => {
                    throw new Error('File upload is not available when combined with Batching');
                }).subscribe({
                    next: (result) => observer.next(result.body),
                    error: (err) => observer.error(err),
                    complete: () => observer.complete(),
                });
                return () => {
                    if (!sub.closed) {
                        sub.unsubscribe();
                    }
                };
            });
        };
        const batchKey = options.batchKey ||
            ((operation) => {
                return this.createBatchKey(operation);
            });
        this.batcher = new BatchLink({
            batchInterval: this.batchInterval,
            batchMax: this.batchMax,
            batchKey,
            batchHandler,
        });
    }
    createOptions(operations) {
        const context = operations[0].getContext();
        return {
            method: prioritize(context.method, this.options.method, defaults.method),
            uri: prioritize(context.uri, this.options.uri, defaults.uri),
            withCredentials: prioritize(context.withCredentials, this.options.withCredentials),
        };
    }
    createBody(operations) {
        return operations.map((operation) => {
            const includeExtensions = prioritize(operation.getContext().includeExtensions, this.options.includeExtensions, false);
            const includeQuery = prioritize(operation.getContext().includeQuery, this.options.includeQuery, true);
            const body = {
                operationName: operation.operationName,
                variables: operation.variables,
            };
            if (includeExtensions) {
                body.extensions = operation.extensions;
            }
            if (includeQuery) {
                body.query = print(operation.query);
            }
            return body;
        });
    }
    createHeaders(operations) {
        var _a, _b;
        return operations.reduce((headers, operation) => {
            return mergeHeaders(headers, operation.getContext().headers);
        }, createHeadersWithClientAwereness({
            headers: this.options.headers,
            clientAwareness: (_b = (_a = operations[0]) === null || _a === void 0 ? void 0 : _a.getContext()) === null || _b === void 0 ? void 0 : _b.clientAwareness,
        }));
    }
    createBatchKey(operation) {
        const context = operation.getContext();
        if (context.skipBatching) {
            return Math.random().toString(36).substr(2, 9);
        }
        const headers = context.headers &&
            context.headers.keys().map((k) => context.headers.get(k));
        const opts = JSON.stringify({
            includeQuery: context.includeQuery,
            includeExtensions: context.includeExtensions,
            headers,
        });
        return prioritize(context.uri, this.options.uri) + opts;
    }
    request(op) {
        return this.batcher.request(op);
    }
}
export class HttpBatchLink {
    constructor(httpClient) {
        this.httpClient = httpClient;
    }
    create(options) {
        return new HttpBatchLinkHandler(this.httpClient, options);
    }
}
HttpBatchLink.ɵprov = i0.ɵɵdefineInjectable({ factory: function HttpBatchLink_Factory() { return new HttpBatchLink(i0.ɵɵinject(i1.HttpClient)); }, token: HttpBatchLink, providedIn: "root" });
HttpBatchLink.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
HttpBatchLink.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1iYXRjaC1saW5rLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9rYW1pbGtpc2llbGEvUmVwby9rYW1pbGtpc2llbGEvYXBvbGxvLWFuZ3VsYXIvcGFja2FnZXMvYXBvbGxvLWFuZ3VsYXIvaHR0cC9zcmMvIiwic291cmNlcyI6WyJodHRwLWJhdGNoLWxpbmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsVUFBVSxFQUFjLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUNMLFVBQVUsRUFDVixVQUFVLElBQUksY0FBYyxHQUc3QixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBQyxTQUFTLEVBQWUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRTlCLE9BQU8sRUFDTCxnQ0FBZ0MsRUFDaEMsS0FBSyxFQUNMLFlBQVksRUFDWixVQUFVLEdBQ1gsTUFBTSxTQUFTLENBQUM7OztBQUlqQixNQUFNLFFBQVEsR0FBRztJQUNmLGFBQWEsRUFBRSxFQUFFO0lBQ2pCLFFBQVEsRUFBRSxFQUFFO0lBQ1osR0FBRyxFQUFFLFNBQVM7SUFDZCxNQUFNLEVBQUUsTUFBTTtDQUNmLENBQUM7QUFFRixNQUFNLE9BQU8sb0JBQXFCLFNBQVEsVUFBVTtJQUtsRCxZQUFvQixVQUFzQixFQUFVLE9BQXFCO1FBQ3ZFLEtBQUssRUFBRSxDQUFDO1FBRFUsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQWM7UUFHdkUsSUFBSSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsYUFBYSxJQUFJLFFBQVEsQ0FBQyxhQUFhLENBQUM7UUFDckUsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFFdEQsTUFBTSxZQUFZLEdB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Q3hCLE9BQU8sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsTUFBTSxPQUFPLEdBQ1gsT0FBTyxDQUFDLE9BQU87WUFDZixPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVwRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQzFCLFlBQVksRUFBRSxPQUFPLENBQUMsWUFBWTtZQUNsQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsaUJBQWlCO1lBQzVDLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCxPQUFPLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQzFELENBQUM7SUFFTSxPQUFPLENBQUMsRUFBYTtRQUMxQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQUtELE1BQU0sT0FBTyxhQUFhO0lBQ3hCLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7SUFBRyxDQUFDO0lBRXZDLE1BQU0sQ0FBQyxPQUFxQjtRQUNqQyxPQUFPLElBQUksb0JBQW9CLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1RCxDQUFDOzs7O1lBUkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUEzS08sVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBIZWFkZXJzfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1xuICBBcG9sbG9MaW5rLFxuICBPYnNlcnZhYmxlIGFzIExpbmtPYnNlcnZhYmxlLFxuICBPcGVyYXRpb24sXG4gIEZldGNoUmVzdWx0LFxufSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcbmltcG9ydCB7QmF0Y2hMaW5rLCBCYXRjaEhhbmRsZXJ9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2xpbmsvYmF0Y2gnO1xuaW1wb3J0IHtwcmludH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQge0JvZHksIENvbnRleHQsIFJlcXVlc3QsIE9wdGlvbnN9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHtcbiAgY3JlYXRlSGVhZGVyc1dpdGhDbGllbnRBd2VyZW5lc3MsXG4gIGZldGNoLFxuICBtZXJnZUhlYWRlcnMsXG4gIHByaW9yaXRpemUsXG59IGZyb20gJy4vdXRpbHMnO1xuXG5pbXBvcnQge0JhdGNoT3B0aW9uc30gZnJvbSAnLi90eXBlcyc7XG5cbmNvbnN0IGRlZmF1bHRzID0ge1xuICBiYXRjaEludGVydmFsOiAxMCxcbiAgYmF0Y2hNYXg6IDEwLFxuICB1cmk6ICdncmFwaHFsJyxcbiAgbWV0aG9kOiAnUE9TVCcsXG59O1xuXG5leHBvcnQgY2xhc3MgSHR0cEJhdGNoTGlua0hhbmRsZXIgZXh0ZW5kcyBBcG9sbG9MaW5rIHtcbiAgcHVibGljIGJhdGNoZXI6IEFwb2xsb0xpbms7XG4gIHByaXZhdGUgYmF0Y2hJbnRlcnZhbDogbnVtYmVyO1xuICBwcml2YXRlIGJhdGNoTWF4OiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LCBwcml2YXRlIG9wdGlvbnM6IEJhdGNoT3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmJhdGNoSW50ZXJ2YWwgPSBvcHRpb25zLmJhdGNoSW50ZXJ2YWwgfHwgZGVmYXVsdHMuYmF0Y2hJbnRlcnZhbDtcbiAgICB0aGlzLmJhdGNoTWF4ID0gb3B0aW9ucy5iYXRjaE1heCB8fCBkZWZhdWx0cy5iYXRjaE1heDtcblxuICAgIGNvbnN0IGJhdGNoSGFuZGxlcjogQmF0Y2hIYW5kbGVyID0gKG9wZXJhdGlvbnM6IE9wZXJhdGlvbltdKSA9PiB7XG4gICAgICByZXR1cm4gbmV3IExpbmtPYnNlcnZhYmxlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IGJvZHkgPSB0aGlzLmNyZWF0ZUJvZHkob3BlcmF0aW9ucyk7XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSB0aGlzLmNyZWF0ZUhlYWRlcnMob3BlcmF0aW9ucyk7XG4gICAgICAgIGNvbnN0IHttZXRob2QsIHVyaSwgd2l0aENyZWRlbnRpYWxzfSA9IHRoaXMuY3JlYXRlT3B0aW9ucyhvcGVyYXRpb25zKTtcblxuICAgICAgICBpZiAodHlwZW9mIHVyaSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICd1cmknIGlzIGEgZnVuY3Rpb24sIHNob3VsZCBiZSBhIHN0cmluZ2ApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVxOiBSZXF1ZXN0ID0ge1xuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICB1cmw6IHVyaSxcbiAgICAgICAgICBib2R5OiBib2R5LFxuICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFscyxcbiAgICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzdWIgPSBmZXRjaChyZXEsIHRoaXMuaHR0cENsaWVudCwgKCkgPT4ge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICdGaWxlIHVwbG9hZCBpcyBub3QgYXZhaWxhYmxlIHdoZW4gY29tYmluZWQgd2l0aCBCYXRjaGluZycsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSkuc3Vic2NyaWJlKHtcbiAgICAgICAgICBuZXh0OiAocmVzdWx0KSA9PiBvYnNlcnZlci5uZXh0KHJlc3VsdC5ib2R5KSxcbiAgICAgICAgICBlcnJvcjogKGVycikgPT4gb2JzZXJ2ZXIuZXJyb3IoZXJyKSxcbiAgICAgICAgICBjb21wbGV0ZTogKCkgPT4gb2JzZXJ2ZXIuY29tcGxldGUoKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICBpZiAoIXN1Yi5jbG9zZWQpIHtcbiAgICAgICAgICAgIHN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBjb25zdCBiYXRjaEtleSA9XG4gICAgICBvcHRpb25zLmJhdGNoS2V5IHx8XG4gICAgICAoKG9wZXJhdGlvbjogT3BlcmF0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUJhdGNoS2V5KG9wZXJhdGlvbik7XG4gICAgICB9KTtcblxuICAgIHRoaXMuYmF0Y2hlciA9IG5ldyBCYXRjaExpbmsoe1xuICAgICAgYmF0Y2hJbnRlcnZhbDogdGhpcy5iYXRjaEludGVydmFsLFxuICAgICAgYmF0Y2hNYXg6IHRoaXMuYmF0Y2hNYXgsXG4gICAgICBiYXRjaEtleSxcbiAgICAgIGJhdGNoSGFuZGxlcixcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlT3B0aW9ucyhvcGVyYXRpb25zOiBPcGVyYXRpb25bXSk6IE9wdGlvbnMge1xuICAgIGNvbnN0IGNvbnRleHQ6IENvbnRleHQgPSBvcGVyYXRpb25zWzBdLmdldENvbnRleHQoKTtcblxuICAgIHJldHVybiB7XG4gICAgICBtZXRob2Q6IHByaW9yaXRpemUoY29udGV4dC5tZXRob2QsIHRoaXMub3B0aW9ucy5tZXRob2QsIGRlZmF1bHRzLm1ldGhvZCksXG4gICAgICB1cmk6IHByaW9yaXRpemUoY29udGV4dC51cmksIHRoaXMub3B0aW9ucy51cmksIGRlZmF1bHRzLnVyaSksXG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHByaW9yaXRpemUoXG4gICAgICAgIGNvbnRleHQud2l0aENyZWRlbnRpYWxzLFxuICAgICAgICB0aGlzLm9wdGlvbnMud2l0aENyZWRlbnRpYWxzLFxuICAgICAgKSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVCb2R5KG9wZXJhdGlvbnM6IE9wZXJhdGlvbltdKTogQm9keVtdIHtcbiAgICByZXR1cm4gb3BlcmF0aW9ucy5tYXAoKG9wZXJhdGlvbikgPT4ge1xuICAgICAgY29uc3QgaW5jbHVkZUV4dGVuc2lvbnMgPSBwcmlvcml0aXplKFxuICAgICAgICBvcGVyYXRpb24uZ2V0Q29udGV4dCgpLmluY2x1ZGVFeHRlbnNpb25zLFxuICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZUV4dGVuc2lvbnMsXG4gICAgICAgIGZhbHNlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGluY2x1ZGVRdWVyeSA9IHByaW9yaXRpemUoXG4gICAgICAgIG9wZXJhdGlvbi5nZXRDb250ZXh0KCkuaW5jbHVkZVF1ZXJ5LFxuICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVF1ZXJ5LFxuICAgICAgICB0cnVlLFxuICAgICAgKTtcblxuICAgICAgY29uc3QgYm9keTogQm9keSA9IHtcbiAgICAgICAgb3BlcmF0aW9uTmFtZTogb3BlcmF0aW9uLm9wZXJhdGlvbk5hbWUsXG4gICAgICAgIHZhcmlhYmxlczogb3BlcmF0aW9uLnZhcmlhYmxlcyxcbiAgICAgIH07XG5cbiAgICAgIGlmIChpbmNsdWRlRXh0ZW5zaW9ucykge1xuICAgICAgICBib2R5LmV4dGVuc2lvbnMgPSBvcGVyYXRpb24uZXh0ZW5zaW9ucztcbiAgICAgIH1cblxuICAgICAgaWYgKGluY2x1ZGVRdWVyeSkge1xuICAgICAgICBib2R5LnF1ZXJ5ID0gcHJpbnQob3BlcmF0aW9uLnF1ZXJ5KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGJvZHk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUhlYWRlcnMob3BlcmF0aW9uczogT3BlcmF0aW9uW10pOiBIdHRwSGVhZGVycyB7XG4gICAgcmV0dXJuIG9wZXJhdGlvbnMucmVkdWNlKFxuICAgICAgKGhlYWRlcnM6IEh0dHBIZWFkZXJzLCBvcGVyYXRpb246IE9wZXJhdGlvbikgPT4ge1xuICAgICAgICByZXR1cm4gbWVyZ2VIZWFkZXJzKGhlYWRlcnMsIG9wZXJhdGlvbi5nZXRDb250ZXh0KCkuaGVhZGVycyk7XG4gICAgICB9LFxuICAgICAgY3JlYXRlSGVhZGVyc1dpdGhDbGllbnRBd2VyZW5lc3Moe1xuICAgICAgICBoZWFkZXJzOiB0aGlzLm9wdGlvbnMuaGVhZGVycyxcbiAgICAgICAgY2xpZW50QXdhcmVuZXNzOiBvcGVyYXRpb25zWzBdPy5nZXRDb250ZXh0KCk/LmNsaWVudEF3YXJlbmVzcyxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUJhdGNoS2V5KG9wZXJhdGlvbjogT3BlcmF0aW9uKTogc3RyaW5nIHtcbiAgICBjb25zdCBjb250ZXh0OiBDb250ZXh0ICYge3NraXBCYXRjaGluZz86IGJvb2xlYW59ID0gb3BlcmF0aW9uLmdldENvbnRleHQoKTtcblxuICAgIGlmIChjb250ZXh0LnNraXBCYXRjaGluZykge1xuICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTtcbiAgICB9XG5cbiAgICBjb25zdCBoZWFkZXJzID1cbiAgICAgIGNvbnRleHQuaGVhZGVycyAmJlxuICAgICAgY29udGV4dC5oZWFkZXJzLmtleXMoKS5tYXAoKGs6IHN0cmluZykgPT4gY29udGV4dC5oZWFkZXJzLmdldChrKSk7XG5cbiAgICBjb25zdCBvcHRzID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgaW5jbHVkZVF1ZXJ5OiBjb250ZXh0LmluY2x1ZGVRdWVyeSxcbiAgICAgIGluY2x1ZGVFeHRlbnNpb25zOiBjb250ZXh0LmluY2x1ZGVFeHRlbnNpb25zLFxuICAgICAgaGVhZGVycyxcbiAgICB9KTtcblxuICAgIHJldHVybiBwcmlvcml0aXplKGNvbnRleHQudXJpLCB0aGlzLm9wdGlvbnMudXJpKSArIG9wdHM7XG4gIH1cblxuICBwdWJsaWMgcmVxdWVzdChvcDogT3BlcmF0aW9uKTogTGlua09ic2VydmFibGU8RmV0Y2hSZXN1bHQ+IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuYmF0Y2hlci5yZXF1ZXN0KG9wKTtcbiAgfVxufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgSHR0cEJhdGNoTGluayB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCkge31cblxuICBwdWJsaWMgY3JlYXRlKG9wdGlvbnM6IEJhdGNoT3B0aW9ucyk6IEh0dHBCYXRjaExpbmtIYW5kbGVyIHtcbiAgICByZXR1cm4gbmV3IEh0dHBCYXRjaExpbmtIYW5kbGVyKHRoaXMuaHR0cENsaWVudCwgb3B0aW9ucyk7XG4gIH1cbn1cbiJdfQ==